<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Redis实战之Redisson使用技巧详解，干活！</title>
      <link href="/2024/05/16/backend/redisson/"/>
      <url>/2024/05/16/backend/redisson/</url>
      
        <content type="html"><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>什么是 Redisson？来自于官网上的描述内容如下！</p><blockquote><p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格客户端（In-Memory Data Grid）。它不仅提供了一系列的 redis<br>常用数据结构命令服务，还提供了许多分布式服务，例如分布式锁、分布式对象、分布式集合、分布式远程服务、分布式调度任务服务等等。</p></blockquote><p>相比于 Jedis、Lettuce 等基于 redis 命令封装的客户端，Redisson 提供的功能更加高端和抽象，逼格高！</p><p>更多功能特性和开发文档说明，可用移步github进行获取，访问地址如下：</p><p><a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">redisson地址</a></p><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a><strong>基本使用</strong></h2><p>跟过去一样，首先创建一个 maven 项目，添加<code>Redisson</code>依赖包。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>单机环境下，简单样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">                .setConnectionMinimumIdleSize(<span class="number">5</span>) <span class="comment">// 设置最下空闲数</span></span><br><span class="line">                .setConnectionPoolSize(<span class="number">10</span>) <span class="comment">// 设置连接池大小</span></span><br><span class="line">                .setIdleConnectionTimeout(<span class="number">3</span>*<span class="number">1000</span>) <span class="comment">// 设置空闲连接超时时间 单位为毫秒</span></span><br><span class="line">                .setConnectTimeout(<span class="number">10</span>*<span class="number">1000</span>) <span class="comment">// 设置连接超时时间 单位为毫秒</span></span><br><span class="line">                .setAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>)</span><br><span class="line">                .setDatabase(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//获取客户端</span></span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        RBucket&lt;String&gt; selfBucket = redissonClient.getBucket(<span class="string">&quot;selfBucket&quot;</span>);</span><br><span class="line">        selfBucket.set(<span class="string">&quot;hello&quot;</span>,<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        selfBucket.set(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        <span class="comment">//获取所有的key</span></span><br><span class="line">        redissonClient.getKeys().getKeys().forEach(key -&gt; System.out.println(key));</span><br><span class="line">        <span class="comment">//关闭客户端</span></span><br><span class="line">        redissonClient.shutdown();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>ps：创建 RedissonClient 对象实例的方式多钟多样，可以直接通过在代码中设置 Redis 服务的相关参数创建，也可以通过加载 JSON 格式、 YAML 格式或者 Spring XML 配置文件来创建，详细的参数配置可用移步上文提到的 Redisson 开发文档。</p></blockquote><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p>Redisson 支持通过<code>RBucket</code>对象来操作字符串数据结构，通过<code>RBucket</code>实例可以设置<code>value</code>或设置<code>value</code>和有效期，简单样例如下！</p><ol><li>简单字符串操作</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字符串操作</span></span><br><span class="line">RBucket&lt;String&gt; rBucket = redissonClient.getBucket(<span class="string">&quot;strKey&quot;</span>);</span><br><span class="line"><span class="comment">// 设置value和key的有效期</span></span><br><span class="line">rBucket.set(<span class="string">&quot;张三&quot;</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//rBucket.getAndDelete();  获取strKey的值并删除strKey这个key</span></span><br><span class="line"><span class="comment">//rBucket.compareAndSet(&quot;张三&quot;,&quot;李四&quot;); 和cas想同先比较后设置</span></span><br><span class="line"><span class="comment">//rBucket.setIfExists(&quot;hello1&quot;); 存在值就设置</span></span><br><span class="line"><span class="comment">// 通过key获取value</span></span><br><span class="line"><span class="comment">//rBucket.isExists(); 判断当前桶是否有值</span></span><br><span class="line"><span class="comment">// rBucket.delete(); 删除桶中数据</span></span><br><span class="line">System.out.println(redissonClient.getBucket(<span class="string">&quot;strKey&quot;</span>).get());</span><br></pre></td></tr></table></figure><ol start="2"><li>对象操作</li></ol><p>Redisson 支持将对象作为<code>value</code>存入<code>redis</code>，被存储的对象事先必须要实现序列化接口<code>Serializable</code>，否则会报错，简单样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字符串对象操作</span></span><br><span class="line">RBucket&lt;user&gt; rBucket = redissonClient.getBucket(<span class="string">&quot;strKey2&quot;</span>);</span><br><span class="line">rBucket.set(<span class="keyword">new</span> <span class="title class_">user</span>().setId(<span class="number">1001</span>).setName(<span class="string">&quot;stone&quot;</span>));</span><br><span class="line">System.out.println(redissonClient.getBucket(<span class="string">&quot;strKey2&quot;</span>).get());</span><br></pre></td></tr></table></figure><h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><p>Redisson 支持通过<code>RMap</code>对象来操作哈希数据结构，简单样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RMap&lt;String, String&gt; rMap = redissonClient.getMap(<span class="string">&quot;mapkey&quot;</span>);</span><br><span class="line">rMap.put(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">rMap.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;赵四&quot;</span>);</span><br><span class="line">rMap.put(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line"><span class="comment">//rMap.putIfAbsent() 如果不存在设置</span></span><br><span class="line"><span class="comment">//rMap.size() 大小</span></span><br><span class="line"><span class="comment">// rMap.clear();清空集合</span></span><br><span class="line">rMap.expire(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">System.out.println(redissonClient.getMap(<span class="string">&quot;mapkey&quot;</span>).get(<span class="string">&quot;name&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RList&lt;user&gt; rList = redissonClient.getList(<span class="string">&quot;listkey&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student1.setId(<span class="number">1</span>);</span><br><span class="line">student1.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">rList.add(student1);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student2.setId(<span class="number">2</span>);</span><br><span class="line">student2.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">rList.add(student2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置过期时间</span></span><br><span class="line">rList.expire(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// rList.subList(0,rList.size()).clear(); 获取子列表</span></span><br><span class="line"><span class="comment">// rList.contains(student1);  判断是否存在student1</span></span><br><span class="line"><span class="comment">// rList.indexOf(student2)   返回student2第一次出现的位置</span></span><br><span class="line"><span class="comment">//  rList.lastIndexOf(student2)   返回student2最后一次出现的位置</span></span><br><span class="line"><span class="comment">//rList.retainAll(Arrays.asList(student2)); 仅保留列表中存在的集合</span></span><br><span class="line"><span class="comment">// rList.toArray() 转化成集合</span></span><br><span class="line"><span class="comment">// 通过key获取value</span></span><br><span class="line">System.out.println(redissonClient.getList(<span class="string">&quot;listkey&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RSet&lt;user&gt; rSet = redissonClient.getSet(<span class="string">&quot;setkey&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student1.setId(<span class="number">1L</span>);</span><br><span class="line">student1.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">rSet.add(student1);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student2.setId(<span class="number">2L</span>);</span><br><span class="line">student2.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">rSet.add(student2);</span><br><span class="line"></span><br><span class="line">rSet.expire(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// rSet.contains(student1);判断集合中是否包含指定的元素。</span></span><br><span class="line"><span class="comment">// rSet.iterator();返回集合的迭代器</span></span><br><span class="line"><span class="comment">// rSet.retainAll(Arrays.asList(student1, student2));仅保留集合中包含在指定集合中的元素，移除其他元素。</span></span><br><span class="line">System.out.println(redissonClient.getSet(<span class="string">&quot;setkey&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h2><p>Redisson 支持通过<code>RSortedSet</code>对象来操作有序集合数据结构，在使用对象来存储之前，实体对象必须先实现<code>Comparable</code>接口，并重写比较逻辑，否则会报错，简单样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RSortedSet&lt;user&gt; sortSetkey = redissonClient.get(<span class="string">&quot;sortSetkey&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student1.setId(<span class="number">1</span>);</span><br><span class="line">student1.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">sortSetkey.add(student1);</span><br><span class="line"></span><br><span class="line"><span class="type">user</span> <span class="variable">student2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line">student2.setId(<span class="number">2</span>);</span><br><span class="line">student2.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">sortSetkey.add(student2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sortSetkey.iterator() 返回集合的迭代器</span></span><br><span class="line">System.out.println(redissonClient.getSortedSet(<span class="string">&quot;sortSetkey&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="添加监听"><a href="#添加监听" class="headerlink" title="添加监听"></a>添加监听</h2><p>以String为例来对redis的一些操作进行监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">## 布隆过滤器</span><br><span class="line"></span><br><span class="line">布隆过滤器（Bloom Filter）是 <span class="number">1970</span> 年由布隆提出的。它实际上是一个很长的二进制向量和一系列随机映射函数。</span><br><span class="line"></span><br><span class="line">布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都比一般的算法要好的多，缺点是有一定的误识别率和删除困难。</span><br><span class="line"></span><br><span class="line">Redisson 支持通过`RBloomFilter`对象来操作布隆过滤器，简单样例如下！</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="type">RBloomFilter</span> <span class="variable">rBloomFilter</span> <span class="operator">=</span> redissonClient.getBloomFilter(<span class="string">&quot;seqId&quot;</span>);</span><br><span class="line"><span class="comment">// 初始化预期插入的数据量为10000和期望误差率为0.01</span></span><br><span class="line">rBloomFilter.tryInit(<span class="number">10000</span>, <span class="number">0.01</span>);</span><br><span class="line"><span class="comment">// 插入部分数据</span></span><br><span class="line">rBloomFilter.add(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">rBloomFilter.add(<span class="string">&quot;200&quot;</span>);</span><br><span class="line">rBloomFilter.add(<span class="string">&quot;300&quot;</span>);</span><br><span class="line"><span class="comment">//设置过期时间</span></span><br><span class="line">rBloomFilter.expire(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 判断是否存在</span></span><br><span class="line">System.out.println(rBloomFilter.contains(<span class="string">&quot;300&quot;</span>));</span><br><span class="line">System.out.println(rBloomFilter.contains(<span class="string">&quot;200&quot;</span>));</span><br><span class="line">System.out.println(rBloomFilter.contains(<span class="string">&quot;999&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="分布式自增id"><a href="#分布式自增id" class="headerlink" title="分布式自增id"></a>分布式自增id</h2><p>ID 是数据的唯一标识，传统的做法是利用 UUID 和<a href="https://cloud.tencent.com/solution/database?from_column=20065&from=20065">数据库</a>的自增 ID。</p><p>但由于 UUID 是无序的，不能附带一些其他信息，因此实际作用有限。</p><p>随着业务的发展，数据量会越来越大，需要对数据进行分表，甚至分库。分表后每个表的数据会按自己的节奏来自增，这样会造成 ID 冲突，因此这时就需要一个单独的机制来负责生成唯一 ID，redis 原生支持生成全局唯一的 ID。</p><p>简单样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line"><span class="comment">//通过redis的自增获取序号</span></span><br><span class="line"><span class="type">RAtomicLong</span> <span class="variable">atomicLong</span> <span class="operator">=</span> redissonClient.getAtomicLong(lockKey);</span><br><span class="line"><span class="comment">//设置过期时间</span></span><br><span class="line">atomicLong.expire(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">// 获取值</span></span><br><span class="line">System.out.println(atomicLong.incrementAndGet());</span><br></pre></td></tr></table></figure><h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>Redisson 最大的亮点，也是使用最多的功能，就是提供了强大的<strong>分布式锁实现</strong>，特点是：使用简单、安全！</p><p>简单使用样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config.useSingleServer()</span><br><span class="line">        .setAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>)</span><br><span class="line">        .setPassword(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">        .setDatabase(<span class="number">0</span>);</span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line"><span class="comment">//获取锁对象实例</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> redissonClient.getLock(lockKey);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//尝试5秒内获取锁，如果获取到了，最长60秒自动释放</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> rLock.tryLock(<span class="number">5L</span>, <span class="number">60L</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="comment">//成功获得锁，在这里处理业务</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取锁成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;获取锁失败，失败原因：&quot;</span> + e.getMessage());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//无论如何, 最后都要解锁</span></span><br><span class="line">    rLock.unlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭客户端</span></span><br><span class="line">redissonClient.shutdown();</span><br></pre></td></tr></table></figure><p>以上是单机环境下的分布式锁实现逻辑，如果是集群环境下，应该如何处理呢？</p><p>Redisson 提供<code>RedissonRedLock</code>操作类，也被称为<strong>红锁</strong>，实现原理简单的总结有以下几点：</p><ul><li>1.如果有多个 redis 集群的时候，当且仅当从大多数（N&#x2F;2+1，比如有3个 redis 节点，那么至少有2个节点）的 Redis 节点都取到锁，并且获取锁使用的总耗时小于锁失效时间时，锁才算获取成功</li><li>2.如果获取失败，客户端会在所有的 Redis 实例上进行解锁操作</li><li>3.集群环境下，redis <a href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>直接不存在任何复制或者其他隐含的分布式协调机制，否则会存在实效的可能</li></ul><p><code>RedissonRedLock</code>简单使用样例如下！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config1.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.3.111:6379&quot;</span>).setPassword(<span class="string">&quot;a123456&quot;</span>).setDatabase(<span class="number">0</span>);</span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redissonClient1</span> <span class="operator">=</span> Redisson.create(config1);</span><br><span class="line"></span><br><span class="line"><span class="type">Config</span> <span class="variable">config2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config2.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.3.112:6379&quot;</span>).setPassword(<span class="string">&quot;a123456&quot;</span>).setDatabase(<span class="number">0</span>);</span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redissonClient2</span> <span class="operator">=</span> Redisson.create(config2);</span><br><span class="line"></span><br><span class="line"><span class="type">Config</span> <span class="variable">config3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config3.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.3.113:6379&quot;</span>).setPassword(<span class="string">&quot;a123456&quot;</span>).setDatabase(<span class="number">0</span>);</span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redissonClient3</span> <span class="operator">=</span> Redisson.create(config3);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取多个 RLock 对象</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient1.getLock(lockKey);</span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(lockKey);</span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(lockKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据多个 RLock 对象构建 RedissonRedLock （最核心的差别就在这里）</span></span><br><span class="line"><span class="type">RedissonRedLock</span> <span class="variable">redLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonRedLock</span>(lock1, lock2, lock3);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//尝试5秒内获取锁，如果获取到了，最长60秒自动释放</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> redLock.tryLock(<span class="number">5L</span>, <span class="number">60L</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="comment">//成功获得锁，在这里处理业务</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取锁成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;获取锁失败，失败原因：&quot;</span> + e.getMessage());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//无论如何, 最后都要解锁</span></span><br><span class="line">    redLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config.useClusterServers()</span><br><span class="line">    .setScanInterval(<span class="number">2000</span>) <span class="comment">// 集群状态扫描间隔时间，单位是毫秒</span></span><br><span class="line">    <span class="comment">//可以用&quot;rediss://&quot;来启用SSL连接</span></span><br><span class="line">    .addNodeAddress(<span class="string">&quot;redis://127.0.0.1:7000&quot;</span>, <span class="string">&quot;redis://127.0.0.1:7001&quot;</span>)</span><br><span class="line">    .addNodeAddress(<span class="string">&quot;redis://127.0.0.1:7002&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br></pre></td></tr></table></figure><h2 id="主从模式"><a href="#主从模式" class="headerlink" title="主从模式"></a>主从模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config.useMasterSlaveServers()</span><br><span class="line">    <span class="comment">//可以用&quot;rediss://&quot;来启用SSL连接</span></span><br><span class="line">    .setMasterAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>)</span><br><span class="line">    .addSlaveAddress(<span class="string">&quot;redis://127.0.0.1:6389&quot;</span>, <span class="string">&quot;redis://127.0.0.1:6332&quot;</span>, <span class="string">&quot;redis://127.0.0.1:6419&quot;</span>)</span><br><span class="line">    .addSlaveAddress(<span class="string">&quot;redis://127.0.0.1:6399&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br></pre></td></tr></table></figure><h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">config.useSentinelServers()</span><br><span class="line">    .setMasterName(<span class="string">&quot;mymaster&quot;</span>)</span><br><span class="line">    <span class="comment">//可以用&quot;rediss://&quot;来启用SSL连接</span></span><br><span class="line">    .addSentinelAddress(<span class="string">&quot;127.0.0.1:26389&quot;</span>, <span class="string">&quot;127.0.0.1:26379&quot;</span>)</span><br><span class="line">    .addSentinelAddress(<span class="string">&quot;127.0.0.1:26319&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
